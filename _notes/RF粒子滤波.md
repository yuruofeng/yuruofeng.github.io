---
title: "Rao-Blackwellized粒子滤波完整理论框架与数学推导"
date: 2025-02-07
category: "Mathematics / Statistics"
icon: "📊"
description: "Rao-Blackwellized粒子滤波(RBPF)通过将状态空间分解为线性与非线性部分，对线性部分采用卡尔曼滤波进行解析边缘化，显著降低估计方差并减少所需粒子数。"
tags: ["Statistics", "Filtering", "Mathematics"]
math: true
---

# Rao-Blackwellized粒子滤波完整理论框架与数学推导

**Rao-Blackwellized粒子滤波(RBPF)通过将状态空间分解为线性与非线性部分，对线性部分采用卡尔曼滤波进行解析边缘化，显著降低估计方差并减少所需粒子数**。这一方法在SLAM、目标跟踪等领域实现了约10倍的粒子效率提升，是贝叶斯滤波领域的核心进展之一。

---

## Rao-Blackwell定理与方差缩减原理

### 定理的数学表述

Rao-Blackwell定理(Rao 1945, Blackwell 1947)提供了通过条件期望改进估计器的理论基础。设$\delta(X)$为待估参数$\theta$的估计量，$T(X)$为充分统计量，则Rao-Blackwell估计量定义为：

$$\delta_{RB}(X) = E[\delta(X) | T(X)]$$

该估计量满足**均方误差不增**性质：

$$E[(\delta_{RB}(X) - \theta)^2] \leq E[(\delta(X) - \theta)^2]$$

其中等号仅在$\delta(X)$已为$T(X)$的函数时成立。方差缩减量可精确表示为：

$$E[(\delta(X) - \theta)^2] - E[(\delta_{RB}(X) - \theta)^2] = E[\text{Var}(\delta(X) | T(X))]$$

### 全方差分解公式

理解RBPF方差缩减的核心是**全方差定律**(Law of Total Variance)：

$$\text{Var}(Y) = E[\text{Var}(Y|X)] + \text{Var}(E[Y|X])$$

当我们用条件期望$E[Y|X]$替代$Y$作为估计量时，新估计量的方差仅为原方差的第二项$\text{Var}(E[Y|X])$，而消除了第一项$E[\text{Var}(Y|X)]$。**这正是Rao-Blackwellization降低方差的数学本质**。

### 在粒子滤波中的应用原理

在状态估计问题中，若能将隐变量分解为$(x_t, z_t)$两部分，使得条件后验$p(z_{0:t}|x_{0:t}, y_{1:t})$可解析求解，则：

- 对$x_{0:t}$使用粒子滤波进行采样
- 对$z_{0:t}$使用卡尔曼滤波(或其他精确推断方法)进行边缘化

Doucet等人(2000)证明了重要性权重满足：

$$\text{Var}(w^{RB}) \leq \text{Var}(w^{PF})$$

方差缩减幅度取决于**被边缘化变量的条件方差大小**——当线性状态的条件不确定性越高时，RBPF的优势越显著。

---

## 状态空间模型的标准形式

RBPF适用于**条件线性高斯状态空间模型(Conditionally Linear Gaussian State-Space Model, CLGSSM)**，其状态向量分解为非线性部分$x_t$和线性部分$z_t$。

### 系统动态方程

**非线性状态动态**（通过粒子滤波处理）：

$$x_t = f(x_{t-1}) + v_t, \quad v_t \sim \mathcal{N}(0, Q_t^x)$$

**条件线性状态动态**（给定$x_t$后为线性高斯，通过卡尔曼滤波处理）：

$$z_t = A_t(x_t)z_{t-1} + B_t(x_t) + w_t, \quad w_t \sim \mathcal{N}(0, Q_t^z)$$

**观测方程**（给定$x_t$后关于$z_t$线性）：

$$y_t = C_t(x_t)z_t + D_t(x_t) + e_t, \quad e_t \sim \mathcal{N}(0, R_t)$$

**关键结构特征**：系统矩阵$A_t(x_t), B_t(x_t), C_t(x_t), D_t(x_t)$均依赖于非线性状态$x_t$，但**条件于$x_t$时，系统对$z_t$呈现标准线性高斯形式**。噪声序列$v_t, w_t, e_t$相互独立且服从高斯分布。

---

## 条件后验分布的核心分解

### 联合后验的因式分解

RBPF的理论核心在于将联合后验分解为两个可分别处理的部分：

$$p(x_{0:t}, z_{0:t} | y_{1:t}) = \underbrace{p(z_{0:t} | x_{0:t}, y_{1:t})}_{\text{高斯分布——卡尔曼滤波}} \times \underbrace{p(x_{0:t} | y_{1:t})}_{\text{非高斯分布——粒子滤波}}$$

### 条件高斯性的保持

为什么$p(z_t | x_{0:t}, y_{1:t})$是高斯分布？当给定非线性状态轨迹$x_{0:t}$时：

1. **状态转移**变为线性高斯：$z_t | z_{t-1}, x_{0:t} \sim \mathcal{N}(A_t z_{t-1} + B_t, Q_t^z)$
2. **观测模型**变为线性高斯：$y_t | z_t, x_t \sim \mathcal{N}(C_t z_t + D_t, R_t)$
3. **高斯分布的线性变换和乘积仍为高斯**

因此，卡尔曼滤波可为每个粒子精确计算条件后验$(z_t | x_{0:t}^{(i)}, y_{1:t}) \sim \mathcal{N}(\hat{z}_t^{(i)}, P_t^{(i)})$。

---

## 粒子滤波部分的数学推导

### 重要性采样

对于非线性状态$x_t$，从建议分布中采样粒子：

$$x_t^{(i)} \sim q(x_t | x_{t-1}^{(i)}, y_t)$$

常用建议分布为**转移先验**：$q(x_t | x_{t-1}^{(i)}, y_t) = p(x_t | x_{t-1}^{(i)})$

### 权重更新公式

递推权重更新：

$$w_t^{(i)} \propto w_{t-1}^{(i)} \cdot \frac{p(y_t | x_t^{(i)}, y_{1:t-1}) \cdot p(x_t^{(i)} | x_{t-1}^{(i)})}{q(x_t^{(i)} | x_{t-1}^{(i)}, y_t)}$$

**RBPF的关键区别**：边缘似然$p(y_t | x_t^{(i)}, y_{1:t-1})$通过**对线性状态积分**计算：

$$p(y_t | x_t^{(i)}, y_{1:t-1}) = \int p(y_t | x_t^{(i)}, z_t) \cdot p(z_t | x_t^{(i)}, y_{1:t-1}) \, dz_t$$

由于被积函数为高斯，该积分有**解析闭式解**：

$$p(y_t | x_t^{(i)}, y_{1:t-1}) = \mathcal{N}(y_t | \hat{y}_{t|t-1}^{(i)}, S_t^{(i)})$$

其中：
- **预测观测**：$\hat{y}_{t|t-1}^{(i)} = C_t(x_t^{(i)}) \hat{z}_{t|t-1}^{(i)} + D_t(x_t^{(i)})$
- **新息协方差**：$S_t^{(i)} = C_t(x_t^{(i)}) P_{t|t-1}^{(i)} C_t(x_t^{(i)})^T + R_t$

权重的对数形式更便于数值计算：

$$\log p(y_t | x_t^{(i)}, y_{1:t-1}) = -\frac{1}{2}\left[\log|2\pi S_t^{(i)}| + (\nu_t^{(i)})^T (S_t^{(i)})^{-1} \nu_t^{(i)}\right]$$

---

## 卡尔曼滤波部分的数学推导

对于每个粒子$i$，运行条件卡尔曼滤波器：

### 预测步骤

**均值预测**：
$$\hat{z}_{t|t-1}^{(i)} = A_t(x_t^{(i)}) \hat{z}_{t-1|t-1}^{(i)} + B_t(x_t^{(i)})$$

**协方差预测**：
$$P_{t|t-1}^{(i)} = A_t(x_t^{(i)}) P_{t-1|t-1}^{(i)} A_t(x_t^{(i)})^T + Q_t^z$$

### 更新步骤

**新息（观测残差）**：
$$\nu_t^{(i)} = y_t - C_t(x_t^{(i)}) \hat{z}_{t|t-1}^{(i)} - D_t(x_t^{(i)})$$

**新息协方差**：
$$S_t^{(i)} = C_t(x_t^{(i)}) P_{t|t-1}^{(i)} C_t(x_t^{(i)})^T + R_t$$

**卡尔曼增益**：
$$K_t^{(i)} = P_{t|t-1}^{(i)} C_t(x_t^{(i)})^T (S_t^{(i)})^{-1}$$

**均值更新**：
$$\hat{z}_{t|t}^{(i)} = \hat{z}_{t|t-1}^{(i)} + K_t^{(i)} \nu_t^{(i)}$$

**协方差更新**：
$$P_{t|t}^{(i)} = (I - K_t^{(i)} C_t(x_t^{(i)})) P_{t|t-1}^{(i)}$$

---

## 有效粒子数与重采样准则

### 有效样本量(ESS)

有效粒子数量化了粒子近似的质量：

$$N_{eff} = \frac{1}{\sum_{i=1}^{N} (\tilde{w}_t^{(i)})^2}$$

其中$\tilde{w}_t^{(i)} = w_t^{(i)} / \sum_{j=1}^{N} w_t^{(j)}$为归一化权重。

**ESS特性**：
- 范围：$1 \leq N_{eff} \leq N$
- $N_{eff} = N$：所有权重相等（理想情况）
- $N_{eff} \to 1$：权重退化至单一粒子（需要重采样）

### 重采样触发条件

当$N_{eff} < N_{threshold}$时执行重采样，典型阈值为$N/2$或$2N/3$。

### 重采样方法比较

| 方法 | 复杂度 | 方差特性 | 推荐程度 |
|------|--------|----------|----------|
| **系统重采样** | O(N) | 低方差 | ★★★ 实践首选 |
| **分层重采样** | O(N) | 理论最优 | ★★★ 有方差下界证明 |
| **残差重采样** | O(N) | 低方差 | ★★☆ |
| **多项式重采样** | O(N log N) | 较高方差 | ★☆☆ 仅作基准 |

**RBPF重采样特殊性**：重采样粒子$i$时，需同时复制$(x_{0:t}^{(i)}, \hat{z}_{t|t}^{(i)}, P_{t|t}^{(i)})$三元组，保持粒子与其卡尔曼滤波状态的对应关系。

---

## RBPF算法的完整实现流程

### 初始化(t=0)

对每个粒子$i = 1, \ldots, N$：

```
1. 非线性状态初始化：x_0^(i) ~ p(x_0)
2. 卡尔曼状态初始化：
   - 均值：μ_0^(i) = E[z_0 | x_0^(i)]
   - 协方差：Σ_0^(i) = Cov[z_0 | x_0^(i)]
3. 权重初始化：w_0^(i) = 1/N
```

### 时间步t的完整迭代

```
对于 t = 1, 2, ..., T：

【步骤1：采样预测】
FOR i = 1 to N:
    采样非线性状态：x_t^(i) ~ q(x_t | x_{t-1}^(i), y_t)
    
【步骤2：卡尔曼预测】
FOR i = 1 to N:
    μ̄_t^(i) = A_t(x_t^(i)) × μ_{t-1}^(i) + B_t(x_t^(i))
    Σ̄_t^(i) = A_t(x_t^(i)) × Σ_{t-1}^(i) × A_t^T + Q_t^z

【步骤3：计算似然与权重】
FOR i = 1 to N:
    新息：ν_t^(i) = y_t - C_t × μ̄_t^(i) - D_t
    新息协方差：S_t^(i) = C_t × Σ̄_t^(i) × C_t^T + R_t
    边缘似然：p(y_t|...) = N(y_t; C_t μ̄_t^(i) + D_t, S_t^(i))
    更新权重：w_t^(i) ∝ w_{t-1}^(i) × p(y_t|...)

【步骤4：卡尔曼更新】
FOR i = 1 to N:
    K_t^(i) = Σ̄_t^(i) × C_t^T × inv(S_t^(i))
    μ_t^(i) = μ̄_t^(i) + K_t^(i) × ν_t^(i)
    Σ_t^(i) = (I - K_t^(i) × C_t) × Σ̄_t^(i)

【步骤5：归一化权重】
w̃_t^(i) = w_t^(i) / Σ_j w_t^(j)

【步骤6：重采样判断】
N_eff = 1 / Σ_i (w̃_t^(i))²
IF N_eff < N/2:
    执行系统重采样
    重置权重：w_t^(i) = 1/N

【步骤7：状态估计输出】
非线性状态MMSE估计：x̂_t = Σ_i w̃_t^(i) × x_t^(i)
线性状态MMSE估计：ẑ_t = Σ_i w̃_t^(i) × μ_t^(i)
```

---

## RBPF与标准粒子滤波的定量对比

### 计算复杂度分析

| 指标 | 标准PF | RBPF |
|------|--------|------|
| **每粒子时间** | O(d) | O(d_x + d_z³) |
| **每粒子内存** | O(d) | O(d_x + d_z²) |
| **总复杂度** | O(N × d) | O(N × (d_x + d_z³)) |

其中$d = d_x + d_z$为总状态维度，$d_x$为非线性维度，$d_z$为线性维度。

### 所需粒子数量对比

**实证研究结论**：在相同估计精度要求下，RBPF所需粒子数显著减少。

| 应用场景 | 标准PF粒子数 | RBPF粒子数 | 缩减倍数 |
|----------|--------------|------------|----------|
| SLAM问题 | 1000+ | 100-200 | **5-10×** |
| 目标跟踪 | 200 | 20 | **10×** |
| 一般非线性系统 | 1000 | 100-200 | **5-10×** |

### 估计精度提升

在相同粒子数下，RBPF的RMSE通常比标准PF低**10-30%**。Lindsten(2011)给出了精确的方差缩减表达式：

$$\sigma_{SPF}^2 - \sigma_{RBPF}^2 = E[\text{Var}(f|\xi_{1:t})]$$

该差值恰为被边缘化变量的平均条件方差，表明**线性状态不确定性越高，RBPF优势越大**。

### 效率权衡分析

| 因素 | 标准PF | RBPF |
|------|--------|------|
| 实现复杂度 | 简单 | 中等（需集成KF） |
| 模型要求 | 任意非线性 | 需具备条件线性结构 |
| 单粒子开销 | 低 | 较高（卡尔曼运算） |
| **总运行时间** | 较高 | **较低**（粒子数少） |
| 并行化难度 | 容易 | 中等 |

---

## 典型应用场景深度解析

### FastSLAM中的应用

SLAM问题的核心发现(Murphy 2000)是：**给定机器人轨迹，地图特征估计相互条件独立**。

**状态分解**：
- **机器人位姿$s_t$**：非线性运动模型 → 粒子滤波
- **地图特征$\theta_n$**：线性高斯观测 → 各特征独立的EKF

**后验因式分解**：

$$p(s_t, \Theta | z_t, u_t) = p(s_t | z_t, u_t) \times \prod_n p(\theta_n | s_t, z_t)$$

**FastSLAM优势**：
- 复杂度从EKF的$O(N^2)$降至$O(M \log N)$（M为粒子数，N为特征数）
- 自然处理数据关联的多假设
- GMapping实现仅需**30-50个粒子**即可完成高质量建图

### 机动目标跟踪

RBPF特别适用于**跳变马尔可夫线性系统(JMLS)**：

**状态分解**：
- **离散模态$r_t$**（机动类型）：粒子滤波采样
- **连续运动学状态$x_t$**（位置、速度）：卡尔曼滤波器组

**应用实例**：协调转弯模型的飞机跟踪、水面无人艇跟踪、弹道轨迹估计等。

### 其他典型应用

- **导航系统**：地形辅助导航(TAN)将位置(非线性观测)与速度偏差(线性)分离
- **传感器融合**：多传感器SLAM融合里程计、IMU和LiDAR数据
- **金融建模**：随机波动率模型中，波动率状态(非线性)与收益率(条件线性)的分离估计
- **航天应用**：卫星姿态估计中，四元数姿态(非线性)与陀螺仪偏差(线性)的联合估计

---

## 结论与技术要点

RBPF的核心价值在于**利用模型的条件线性结构实现精确边缘化**，从而在理论上保证方差不增，在实践中实现约一个数量级的粒子效率提升。其成功应用的关键前提是正确识别状态空间中的线性-非线性分解结构。

**选择RBPF的判据**：当状态空间具有显著的条件线性高斯子结构（$d_z \geq 2$），且线性状态的条件不确定性较高时，RBPF相比标准粒子滤波可获得显著的计算效率和估计精度优势。在SLAM、目标跟踪、导航等领域，这种结构普遍存在，使RBPF成为这些应用的首选算法框架。